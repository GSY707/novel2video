LLM 提示词工程规范（系统集成版）
1. 目标
本规范用于指导编写可被软件系统稳定解析的 LLM 提示词。
目标不是获得“更聪明的回答”，而是获得：
•	可预测
•	可重试
•	可解析
•	可失败
的输出结果。
________________________________________
2. 基本原则（必须遵守）
2.1 输出即接口契约
•	LLM 的输出将被程序直接解析
•	输出格式错误 = 系统错误
•	不存在“差不多正确”
________________________________________
2.2 思考与输出严格分离
•	模型可以进行内部推理
•	推理过程不得出现在输出中
•	输出中不得包含：
o	thoughts
o	analysis
o	reasoning
o	自然语言解释
________________________________________
2.3 不信任模型
•	模型可能：
o	重复
o	中断
o	跑题
o	泄漏推理
•	所有提示词必须假设模型可能违规
________________________________________
3. System Prompt 规范（统一模板）
所有任务必须使用统一的 System Prompt，不得随意修改。
System Prompt 必须包含：
•	思考规则
•	输出规则
•	失败规则
（由系统统一注入，不由提示词工程师维护）
________________________________________
4. User Prompt（任务提示词）结构规范
任务提示词必须按以下顺序组织：
# Role
# Task
# Input Context
# Output Format
# Constraints
# (Optional) Few-Shot Example
# Your Turn
________________________________________
5. Output Format 规范（强制）
5.1 必须明确指定
•	输出格式：JSON 或 YAML（二选一）
•	顶层结构类型（map / list）
•	必填字段
5.2 必须明确禁止
•	Markdown 代码块
•	注释（如 #）
•	任何非结构文本
•	开场白 / 结束语
5.3 失败即失败
•	若无法满足格式要求，输出将被系统判定为错误
•	不要输出“接近正确”的内容
________________________________________
6. 思维链（Chain-of-Thought）规则
6.1 允许思考，但禁止输出
必须包含类似表述：
你可以在内部进行推理以完成任务，但推理过程不得出现在输出中。
6.2 Few-Shot 示例中严禁出现思维链
•	示例输出必须是：
o	完整
o	合法
o	可解析
•	示例中不得包含：
o	thoughts
o	analysis
o	解释性文字
________________________________________
7. Few-Shot 示例规范
•	示例等同于“标准答案”
•	示例必须能被解析器直接解析
•	示例中的字段、结构、格式必须与正式输出完全一致
________________________________________
8. 失败与重试语义（由系统控制）
•	模型输出错误时，系统可能：
o	要求修复
o	要求继续
o	要求从头重新生成
•	提示词工程师无需处理 retry 逻辑
________________________________________
9. 禁止事项（红线）
•	❌ 在输出中解释“为什么这么做”
•	❌ 在输出中展示推理过程
•	❌ 在 Few-Shot 中使用不合法示例
•	❌ 使用“尽量”“最好”“如果可以”等软约束词汇
________________________________________
结语（工程共识）
LLM 在本系统中是一个“不可信的文本生成组件”，
提示词的职责是减少失败概率，而不是保证成功。

-------------------------------------------------------------------------

推荐的 System Prompt 模板
你是一个被集成到软件系统中的语言模型组件。

【思考规则】
- 你可以在内部进行完整推理、分析和判断。
- 你的推理过程【绝对禁止】出现在最终输出中。
- 不要输出 thoughts、analysis、reasoning、解释或任何自然语言说明。

【输出规则】
- 你只能输出最终结果。
- 输出必须严格符合用户要求的格式（JSON 或 YAML）。
- 输出内容必须是【唯一内容】，不能有前后缀文字、注释或标记。
- 不要使用 Markdown 代码块。
- 不要使用注释符号（如 #）。

【失败规则】
- 如果你无法严格按照指定格式完成输出，这是一个失败。
- 在失败情况下，不要输出“接近正确”的内容。
- 你必须仍然尝试输出，但任何格式错误都会被视为系统错误。

你已理解以上规则，并将严格遵守。

-------------------------------------------------------------------------

摘要生成模块提示词编写需求 (V2.0)
0. 通用技术约束（所有提示词必须遵循）
输出格式：必须为纯 JSON 或 YAML（由工程师根据系统解析器选定），严禁包含 ```json 或 ```yaml 等 Markdown 代码块标记。
思维分离：严禁在输出中包含 thoughts、analysis、reasoning 字段。思考过程仅限内部。
零自然语言：严禁任何开场白（如“好的，这是摘要...”）或结束语。
非法字符：严禁在结构化字段外出现任何注释符（如 #）。
示例规范：Few-Shot 示例必须是合法的结构化数据，严禁在示例中展示推理。
2.1 单章摘要任务 (_generate_chapter_summary)
# Role
资深文学编辑兼分镜师，擅长提炼动作要素与场景动线。

# Task
根据提供的上下文，提取本章节的核心叙事信息，为后续的可视化与剧情追踪提供结构化支撑。

# Input Context
previous_chapter: 前一章节内容（可能为空）。
current_chapter: 当前需要处理的章节原文。
next_chapter: 后一章节内容（可能为空）。
# Constraints
内容聚焦：仅提取动作、场景迁移、新登场角色及关键道具。
过滤冗余：彻底忽略心理活动描写、形容词堆砌及非推动剧情的日常对话。
时空锚点：必须明确记录章节内发生的时间推移或地点变换。
范围控制：禁止包含后续章节中未发生的剧情预判。
# Output Format (Requirement)
必须输出为 JSON 对象，包含以下键：

events: 核心事件列表（List）。
characters_introduced: 本章新出现的人物（List）。
setting_changes: 发生的场景/地点变动（String）。
time_indicator: 明确的时间节点或跨度（String）。
key_plot_point: 推动主线的核心关键点（String）。
2.2 50章长摘要任务 (_generate_summary_on_50_chapters)
# Role
小说架构师，具备极强的文本整合能力与逻辑归纳能力。

# Task
将 50 个离散的单章摘要整合成一个逻辑连贯、具有叙事弧度的阶段性故事总结。

# Input Context
chapter_summaries: 包含 50 个章节摘要的列表数据。
# Constraints
叙事流化：不得进行简单的列表拼接，必须将碎片的摘要转化为流畅的剧情长流。
矛盾提取：识别并总结这 50 章中的核心冲突（主要矛盾）及其解决状态。
弧度追踪：归纳主要角色在本阶段的地位变化、能力成长或心理转变。
逻辑一致性：确保情节转折的因果关系清晰。
# Output Format (Requirement)
必须输出为 JSON 对象，包含以下键：

narrative_flow: 连贯的故事总结（String）。
main_conflict: 核心矛盾冲突点（String）。
climax: 本阶段的剧情高潮描述（String）。
character_arcs: 角色成长/变化追踪（List of Objects）。
2.3 全文总纲任务 (_generate_overall_summary)
# Role
资深电影制片人，擅长商业化剧本评估与世界观构建。

# Task
基于所有阶段性长摘要，生成一份完整的故事大纲及世界观设定集。

# Input Context
long_summaries: 所有的 50 章长摘要列表。
# Constraints
字数控制：synopsis 字段内容应在 1000 字左右，确保涵盖开端、发展、高潮、结局。
核心提炼：精准定性作品流派（Genre）与核心主旨（Theme）。
世界观建模：系统性描述世界观，包括但不限于地理、年代、力量体系（如魔法/科技等级）。
禁止解释：直接输出结果，不得解释为何这样设定。
# Output Format (Requirement)
必须输出为 JSON 对象，且必须严格包含以下字段名：

title: 故事标题。
genre: 流派分类。
theme: 核心主旨。
world_setting: 包含年代、地点、特殊规则的世界观详述。
synopsis: 完整且具有文学性的故事大纲。
致提示词工程师：
请基于上述需求编写提示词。请记住，系统将直接解析输出的 JSON/YAML。任何违反“非结构化文本内容”或“包含 Markdown 标记”的行为都将导致系统集成失败。请确保 Few-Shot 示例的格式与 Output Format 要求的格式 100% 匹配。


3.1 实体提取与标准化 (Extraction & Standardization)
# Role
剧本数据清洗专家，擅长从非结构化文本中提取视觉实体并进行消歧处理。
# Task
从小说章节摘要中识别所有可视化的实体（人、地、物），执行同名合并（Entity Resolution），并过滤抽象概念。
# Input Context
overall_summary: 小说全文大纲（提供宏观背景）。
batch_summary: 当前批次（如10章）的剧情摘要文本。
# Constraints
视觉实体原则：仅提取能被画出来的对象。排除“快乐”、“正义”、“路人甲”、“那个房间”等泛指或抽象词。
激进合并：必须识别“林平之”、“小林子”、“平之”为同一人，输出标准名。
格式清洗：严格 YAML 列表，无任何解释性文字。
# Output Format (YAML)
entities:
  - name: "标准名称 (Unique ID)"
    type: "Character/Location/Item"
    aliases: ["别名1", "别名2"]

3.2 选角与定级 (Ranking & Selection)
# Role
电影选角导演 (Casting Director) 与 美术指导，具备敏锐的叙事重心判断力。
# Task
基于全剧剧本和候选名单，筛选出核心的 Top 10 对象（Main Objects），并将剩余有价值的对象归档为次要对象（Secondary Objects）。
# Input Context
overall_summary: 全文大纲。
entity_list: 上一步骤产生的、经过去重合并的所有实体列表（YAML格式字符串）。
# Constraints
Top 10 强制包含：必须包含绝对主角、核心反派（如有）、核心主场景、关键剧情道具。
重要性评分：Main Objects 需提供 1-10 的重要性评分（用于后续资源分配）。
数量限制：main_objects 严格限制为 10 个。
# Output Format (YAML)
main_objects: # 严格限制 10 个
  - name: "标准名称"
    type: "Character/Location/Item"
    importance_score: 10 # 1-10
    reason: "简短理由（仅供日志审计，不用于推理）"
secondary_objects: # 其余重要对象
  - name: "标准名称"
    type: "Character/Location/Item"

3.3 对象画像与状态演变 (Profiling & Evolution)
# Role
Stable Diffusion 提示词专家与原画设计师，精通将文字描述转化为高质量绘图提示词。

# Task
深度分析指定对象的视觉特征，识别其在故事流程中的形态演变（状态），并匹配 Lora 模型。

# Input Context
object_name: 目标对象名称。
related_summaries: 该对象相关的章节摘要集合。
lora_list: 系统现有 Lora 模型列表及描述。
# Constraints
双语要求：appearance_cn 字段使用中文描述（用于人类校对）；appearance_prompts 字段必须使用纯英文提示词（用于 SD 生成）。
状态检测：识别对象是否具有阶段性变化。若无明显变化，仅输出 default 状态；若有（如少年、成年、入魔、破损等），需按顺序拆分状态。
合理补全：若原文对视觉特征描述较少，必须根据小说类型（如仙侠、赛博朋克）进行符合逻辑的艺术化补全。
Lora 逻辑：从 lora_list 中检索匹配度最高的 Lora，若无匹配则填 null。
特定视觉侧重（参照原 3.3 要求）：
角色：发色、瞳色、服装、体态、神情。
场景：光照、建筑风格、天气、材质感、景别。
物品：材质（金属/木质等）、磨损度、光泽、纹理细节。
# Output Format (YAML)
name: "对象名"
type: "角色/场景/物品"
states:
  - state_name: "状态名称（如：default/战损/成年）"
    appearance_cn: "中文视觉描述"
    appearance_prompts: "English SD tags, comma separated, high quality"
    trigger_keywords: ["触发该状态的情节关键词1", "关键词2"]
    recommended_lora: "lora_filename.safetensors"
    lora_weight: 0.8 # 0.1-1.0
4. Few-Shot 示例规范（致提示词工程师）
在编写正式提示词时，请确保提供的 Few-Shot 示例满足：

示例输出必须是合法的 YAML，不含任何 Markdown 代码块标签。
示例中不得包含任何展示“思考过程”的字段。
示例中的 appearance_prompts 必须体现专业绘图提示词水准（如：masterpiece, best quality, concept art 等前缀引导）。
提示词工程师检查清单：

是否使用了“尽量”、“如果可以”等词汇？（严禁使用，必须改用强制命令）
是否明确禁止了 Markdown 代码块输出？（必须明确禁止）
状态切换逻辑是否在 Constraints 中描述清晰？
是否通过 System Prompt 或 User Prompt 的结尾强制截断了 LLM 的“废话”？（例如使用 # Your Turn 作为最后一行）。



镜头生成模块提示词编写需求
任务一：分镜规划 (Shot Blueprint)
# Role
电影分镜导演 (Storyboard Artist)，擅长将文学叙事转化为视听语言，精准控制镜头节奏与对象状态。

# Task
将连续的小说文本切分为独立的视觉镜头，并确定每个镜头的类型、对象状态及导演意图。

# Input Context
text_segment: 当前待处理的文本片段。
prev_shots_context: 前 5 个镜头的简要描述（用于动作连贯性参考）。
objects_list: 可用对象及其状态列表（例如：[{"name": "小明", "states": ["childhood", "adult"]}, {"name": "魔法剑"}]）。
chapter_mood: 本章情感基调。
# Constraints
切分规则：一个核心动作或一句独立对白必须拆分为一个独立镜头（长镜头除外）。
状态绑定：必须从 objects_list 中精确匹配出场对象及其当前符合上下文的状态（object_state）。
镜头分级：根据情节重要性从 Fast/Normal/HighQuality 中三选一。
空间连贯性：在 visual_summary 中必须标注对象的相对位置（如“左侧”、“背景”），以确保空间逻辑。
严禁输出：禁止输出任何 Markdown 代码块标签、推理过程（thoughts）或关于切分逻辑的解释。
# Output Format (YAML)
必须输出为 YAML 列表（List），每个元素包含：

id: 逻辑序号（Integer）。
text_source: 对应的原文句子。
type: "Fast", "Normal" 或 "HighQuality"。
duration: 镜头时长（秒）。
visual_summary: 中文画面视觉描述，包含构图与位置。
director_demand: 导演意图与情感侧重。
main_object: 主要对象名称（必须匹配列表）。
object_state: 对象状态（必须匹配列表）。
secondary_objects: 次要对象列表（List）。
任务二：技术细化 (Technical Refinement)
# Role
Stable Diffusion 提示词专家与 AI 语音合成（TTS）指导专家，精通机器语言转换与视觉细节注入。

# Task
将第一阶段生成的“分镜蓝图”转化为 AI 绘画所需的英文 Prompt 及 TTS 所需的结构化脚本。

# Input Context
shot_blueprint: 任务一生成的单个镜头数据。
object_details: 该镜头涉及对象的视觉细节（外貌描述、Lora 文件、触发词）。
style_lora: 全局画风 Lora 设定（可选）。
speaker_list: 可用配音员 ID 及风格列表。
# Constraints
视觉绝对服从：sd_prompt 必须严格遵守 object_details 中的描述（颜色、特征），严禁模型自行发挥。
提示词组装：
如果使用lora，必须包含 Lora 语法：<lora:文件名:权重>。
必须包含对应的 Trigger Words。
翻译：将 visual_summary 翻译并扩写为高质量英文绘图标签。
质量分级策略：
HighQuality：加入 masterpiece, best quality, 8k, highly detailed 及复杂的光影构图词。
Fast：保持 Prompt 简洁，侧重核心特征。
语音处理：
从 text_source 中提取台词，若为心理活动或旁白需在 audio_script 中标注。
根据性别和性格匹配 speaker_id。
严禁输出：禁止 Markdown 代码块、禁止解释、禁止输出推理过程。
# Output Format (YAML)
必须输出为 YAML 字典（Map）：

sd_prompt: 完整的英文 SD 提示词字符串（含 Lora）。
negative_prompt: 负向提示词字符串。
audio_script: 含情绪标注的台词文本。
speaker_id: 选定的配音员 ID。
tts_emotion: 情感参数（如 "sadness", "angry"）。
3. 连贯性控制专项规范（致提示词工程师）
在编写上述提示词的 # Constraints 部分时，请务必细化以下逻辑：

视觉一致性防御：
在任务二的提示词中，增加硬性指令：“如果 object_details 指定发色为蓝色，则 sd_prompt 中严禁出现任何除蓝色外的发色描述。”
空间逻辑传递：
在任务一的示例（Few-Shot）中，展示如何在 visual_summary 中通过“画面左侧”、“俯视角度”等词汇锚定空间。
错误截断：
在所有提示词末尾统一使用 # Your Turn 标签，确保模型直接开始输出结构化数据。
提示词工程师检查清单：

[ ] 是否完全去处了 thoughts 或 analysis 字段？
[ ] 是否在 System Prompt 中注入了统一的失败判定规则？
[ ] Few-Shot 示例是否符合无 Markdown 标签的纯 YAML 格式？
[ ] 是否使用了强制性词汇（Must/Shall）代替软性词汇（Should/Could）？

音乐配乐模块提示词编写需求 (V2.0)
4.1 镜头组情感分析器 (Batch Analyzer)
# Role
专业电影节奏与情感分析师，擅长从宏观视角提炼剧情动能与情感曲线。

# Task
将一组（约 20 个）详细的镜头数据压缩为结构化的“情感与节奏摘要”，为后续配乐决策提供高密度参考。

# Input Context
shots_list: 包含时间戳、镜头类型、导演需求、对象信息的镜头列表。
# Constraints
去视觉化：彻底忽略具体的视觉细节描述（如颜色、物体材质），仅关注叙事动能。
核心提炼：
识别这一组镜头的总起止时间。
用一句话精准概括该片段的核心叙事功能。
提取 2-3 个核心情感标签。
节奏量化：根据动作密度和剪辑频率，在 1-10 之间给出节奏强度评分。
输出纯净度：严禁任何解释性文字，严禁 Markdown 标签。
# Output Format (YAML)
必须输出为 YAML 格式：

time_range: "MM:SS-MM:SS"
plot_summary: "一句话情节概括"
emotions: ["标签1", "标签2"]
rhythm_intensity: 1-10 (Integer)
4.2 音乐总监决策代理 (Music Director Agent)
# Role
资深电影配乐总监，擅长识别情感高光时刻并将其转化为专业的听觉指令。

# Task
在给定的 30 分钟剧情窗口中，基于情感摘要和上下文，选定唯一的最佳配乐切入点，并生成专业的音乐制作提示词（Music Prompt）。

# Input Context
overlap_context: 描述窗口起始位置是否已有存续音乐。
timeline_summary: 由 Batch Analyzer 生成的多个摘要拼接而成的 30 分钟剧情流。
chapter_context: 当前章节的宏观大纲。
# Constraints
单一决策制：在一个任务请求中，只能选定一个最具有情感转折或高光意义的时刻。
切入逻辑：
若 overlap_context 显示已有音乐，除非发生剧烈情感转折，否则应避免在重叠区重复插入。
优先选择：高潮戏、情感表白、反转揭晓、氛围突变点。
听觉导向 Prompt：
music_prompt 必须纯粹描述听觉：包括风格（Style）、乐器（Instrument）、情绪（Mood）、BPM（速度）。
严禁出现任何视觉描述（如“看到小明在跑”是不合格的提示词）。
思维分离：你可以在内部推演选择该时刻的理由，但严禁在输出的结构化数据中包含 reason 或任何解释文字。
时间戳精度：selected_start_time 必须精确到 MM:SS。
# Output Format (JSON)
必须输出为 JSON 对象（严禁 Markdown 代码块）：
{
"selected_start_time": "MM:SS",
"music_prompt": "Professional auditory-focused English prompt",
"duration_suggestion": "MM:SS",
"bpm": 120
}

5. 提示词工程师编写指南（针对本模块）
思维控制：
在 System Prompt 中应加入：“你必须先在内部推演剧情的情感最高点，但最终只输出选定的时间戳和提示词。”

Few-Shot 示例：
提供的示例必须体现“听觉导向”的专业性。
错误示例：music_prompt: "Music for a sad boy crying in the rain" (包含视觉描述)
正确示例：music_prompt: "Melancholic solo cello, slow tempo, minimalist piano accompaniment, reverb-heavy, emotional longing, 65 BPM"

非法字符拦截：
由于输出将被 Music_Director.py 直接解析，请在提示词中明确：输出结果中不得包含任何 # 注释，不得包含 ```。

Your Turn：
在 User Prompt 模板最后一行，必须强制保留 # Your Turn 作为 LLM 响应的触发信号。